#  Open API 安全策略

## 了解

### 安全需求：

+ 平台需要有可靠的主体架构保证服务的完成。在大并发大流量的情况下，必须保证自身的稳定性和可用性，同时也要兼顾平台中开放的服务不相互干扰和影响。
+ 平台的用户群基数大，彼此间关系复杂，对用户资料和活动的隐私性需要有严格的规范和保证。
+ 随着第三方应用的增多，平台需要保障这些应用能安全有序地接入系统。

### 安全设计思路：
 
 + 平台安全
 + 应用安全
 + 服务安全
 + 用户隐私安全

 
### 安全设计实施方案应遵循的五要素：

 + 分层安全性；
 + 最小权限策略；
 + 特定角色安全；
 + 用户隐私保护意识；
 + 安全监控。

### 类授权策略

| 分类 | 类型 | 访问对象 | 作用 | 安全级别 | 手段 |
|---------|-------|--------|--------|-------|--------|
| 免授权 | |公开类信息（如搜索引擎搜索到的结构等）| | 低 | 申请应用ID |
| 应用授权 | 非商业、商业 | 用户相关公开类信息 （如SNS中的个人公开信息）| 服务商提供交验应用身份，保证数据传输没有被篡改 | 中 | 数字签名 |
| 用户授权 | web、桌面、移动 | 个人用户非公开的信息（如淘宝用户隐私信息）| 在保障用户个人隐私数据的安全性前提下，提供给应用开发者访问和操作用户个人信息的能力| 高 | OAuth代理授权,用户名、密码代理授权 |

+ 免授权，只需要开发者申请应用ID即可使用服务。
+ 应用授权是最基础的Open API开发授权策略，作用是让服务提供商能够核对每一次服务请求者的身份，同时也保证了服务开发商的自身利益，与免授权之间的区别就是是否需要在请求中带上数字签名来交验请求者身份。
+ 用户授权一般是基于应用授权之上的更高层次的授权认证，为了保障使用应用的终端用户数据不会在用户不知情或未授权的情况下被访问和修改，使用户隐私泄露或者蒙受损失。


## 实施
开放API主要是第三方平台获取我平台开放的数据，运行在第三方平台的数据，我方平台并不能确保其安全。从平台和数据两个方面考虑，并参考类授权策略和安全设计五要素。从两个方面对API进行分类。以本站为例。

从平台安全考虑：

+ 需审核第三方平台，有些数据比较重要，需要第三方平台提供相关信息，审核通过，为其分配AppKey和AppSecret才能调用
+ 不需审核平台,可直接调用



从数据方向考虑，数据主要分为：行情数据、交易数据、用户数据。

+ 行情数据：可以直接获取
+ 交易数据：需要采用数字签名才能获取
+ 用户数据：需要用户授权才能获取

从API安全维护考虑，为了确保第三方平台合法使用API，需要对第三方调用API进行实时监控。（比如，调用次数、调用的ip地址、调用时间与时长及审计平台配置和漏洞等）通过定期对这些行为进行统计和分析，及时发现潜在的危险。对已发生的安全事故进行安全漏洞查找，预防再次发生同样的事故。

API结构可参考：
![HROP整体框架及各组件交互流程](/Users/yuan/Desktop/hrop2.png)

### 涉及到的技术：
#### OAuth2.0 协议

#### 数字签名验证：
 1、[淘宝签名算法](http://open.taobao.com/doc2/detail.htm?spm=a219a.7629140.0.0.3xn6a8&treeId=49&articleId=101617&docType=1#s4)：
 
 为了防止API调用过程中被黑客恶意篡改，调用任何一个API都需要携带签名，TOP服务端会根据请求参数，对签名进行验证，签名不合法的请求将会被拒绝。TOP目前支持的签名算法有两种：MD5(sign_method=md5)，HMAC_MD5(sign_method=hmac)，签名大体过程如下：
 
 +  对所有API请求参数（包括公共参数和业务参数，但除去sign参数和byte[]类型的参数），根据参数名称的ASCII码表的顺序排序。如：foo=1, bar=2, foo_bar=3, foobar=4排序后的顺序是bar=2, foo=1, foo_bar=3, foobar=4。
 +  将排序好的参数名和参数值拼装在一起，根据上面的示例得到的结果为：bar2foo1foo_bar3foobar4。
 +  把拼装好的字符串采用utf-8编码，使用签名算法对编码后的字节流进行摘要。如果使用MD5算法，则需要在拼装的字符串前后加上app的secret后，再进行摘要，如：md5(secret+bar2foo1foo_bar3foobar4+secret)；如果使用HMAC_MD5算法，则需要用app的secret初始化摘要算法后，再进行摘要，如：hmac_md5(bar2foo1foo_bar3foobar4)。
 +  将摘要得到的字节流结果使用十六进制表示，如：hex(“helloworld”.getBytes(“utf-8”)) = “68656C6C6F776F726C64”

 说明：MD5和HMAC_MD5都是128位长度的摘要算法，用16进制表示，一个十六进制的字符能表示4个位，所以签名后的字符串长度固定为32个十六进制字符。


 

#### 密匙明文验证模式

#### 总是使用ssl：并看不懂ssl😫



参考：

+ [安全漏洞解决办法－淘宝](http://open.taobao.com/doc2/detail.htm?spm=a219a.7629140.0.0.aYVJH5&treeId=23&articleId=813&docType=1)
+ [Open API分析、实践和思索](http://www.infoq.com/cn/articles/open-api-practice)
+ 开放平台解决方案及其安全策略研究
+ [易极付安全策略](https://apidoc.yiji.com/website/security_policy.html)
+ [Best Practices for Designing a Pragmatic RESTful API](http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api)
+ [[译]关于SSL,Web开发者应知但可能不知的二三事](http://mp.weixin.qq.com/s?__biz=MzIxMjE0MjM4NA==&mid=401838121&idx=1&sn=905aacf020eb50cbe16a354c89984011#rd)
+ [How to Use SSL Sockets with PHP](http://www.devdungeon.com/content/how-use-ssl-sockets-php)
+ [数字签名是什么？](http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html)